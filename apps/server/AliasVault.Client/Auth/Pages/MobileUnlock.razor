@page "/user/mobile-unlock"
@inherits AliasVault.Client.Auth.Pages.Base.LoginBase
@layout Auth.Layout.MainLayout
@attribute [AllowAnonymous]
@using System.Text.Json
@using AliasVault.Client.Auth.Components
@using AliasVault.Client.Auth.Services
@using AliasVault.Client.Utilities
@using AliasVault.Cryptography.Client
@using Microsoft.Extensions.Localization
@implements IDisposable

<h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
    @Localizer["PageTitle"]
</h2>

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="mb-4 p-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400">
        @_errorMessage
    </div>
}

<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm">
    <p class="text-gray-700 dark:text-gray-300 mb-6">
        @Localizer["ScanQrCodeDescription"]
    </p>

    <div class="flex flex-col items-center mb-6">
        @if (_isLoading)
        {
            <SmallLoadingIndicator />
        }

        @if (!string.IsNullOrEmpty(_qrCodeUrl))
        {
            <div id="mobile-unlock-qr" data-url="@_qrCodeUrl" class="@(_isLoading ? "hidden" : "") mb-4 p-4 bg-white rounded-lg border-4 border-gray-200 dark:border-gray-600">
                <!-- QR code will be rendered here -->
            </div>
            @if (!_isLoading)
            {
                <div class="text-gray-700 dark:text-gray-300 text-sm">
                    @FormatTime(_timeRemaining)
                </div>
            }
        }
    </div>

    <div class="flex w-full">
        <button type="button" @onclick="HandleCancel" class="w-full text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700">
            @Localizer["CancelButton"]
        </button>
    </div>
</div>

<FooterLogin />

@code {
    private string? _qrCodeUrl;
    private string? _errorMessage;
    private int _timeRemaining = 120; // 2 minutes in seconds
    private MobileUnlockUtility? _mobileUnlockUtility;
    private bool _isLoading = true;
    private System.Threading.Timer? _countdownTimer;

    private IStringLocalizer Localizer => LocalizerFactory.Create("Pages.Auth.MobileUnlock", "AliasVault.Client");
    private IStringLocalizer ApiErrorLocalizer => LocalizerFactory.Create("ApiErrors", "AliasVault.Client");

    /// <inheritdoc />
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        // Check if already authenticated
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            NavigationManager.NavigateTo("/");
            return;
        }
    }

    /// <inheritdoc />
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (firstRender)
        {
            await InitiateMobileUnlockAsync();
        }
    }

    /// <summary>
    /// Initialize mobile unlock on component mount.
    /// </summary>
    private async Task InitiateMobileUnlockAsync()
    {
        try
        {
            _isLoading = true;
            _errorMessage = null;
            StateHasChanged();

            // Initialize mobile unlock utility
            _mobileUnlockUtility = new MobileUnlockUtility(Http, JsInteropService, ScopedServices.GetRequiredService<ILogger<MobileUnlockUtility>>());

            // Initiate mobile unlock and get QR code data
            var requestId = await _mobileUnlockUtility.InitiateAsync();

            // Generate QR code with AliasVault prefix for mobile unlock
            _qrCodeUrl = $"aliasvault://mobile-unlock/{requestId}";

            // Render QR code first while still showing loading animation
            StateHasChanged();
            await Task.Delay(100); // Give DOM time to render
            await JsInteropService.GenerateQrCode("mobile-unlock-qr");

            // Wait for QR code to be fully rendered before hiding loading animation
            await Task.Delay(500);

            _isLoading = false;
            StateHasChanged();

            // Start countdown timer
            StartCountdownTimer();

            // Start polling for response
            await _mobileUnlockUtility.StartPollingAsync(
                HandleSuccessfulAuthAsync,
                HandleErrorAsync);
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.NotFound)
        {
            // 404 means the mobile unlock endpoint doesn't exist - server version is too old
            // TODO: this check can be removed at a later time when v1.0 is ready and 0.25.0 release has been out for a while.
            _isLoading = false;
            _errorMessage = Localizer["ServerVersionTooOld"];
            StateHasChanged();
        }
        catch (Exception)
        {
            _isLoading = false;
            _errorMessage = Localizer["InitializationError"];
            StateHasChanged();
        }
    }

    /// <summary>
    /// Handle successful authentication.
    /// </summary>
    private async Task HandleSuccessfulAuthAsync(string username, string token, string refreshToken, string decryptionKey, string salt, string encryptionType, string encryptionSettings)
    {
        try
        {
            _isLoading = true;
            _qrCodeUrl = null;
            StateHasChanged();

            // Store the tokens in local storage
            await AuthService.StoreAccessTokenAsync(token);
            await AuthService.StoreRefreshTokenAsync(refreshToken);

            // Convert decryption key from base64 string to byte array
            var decryptionKeyBytes = Convert.FromBase64String(decryptionKey);

            // Store the encryption key in memory
            await AuthService.StoreEncryptionKeyAsync(decryptionKeyBytes);

            await AuthStateProvider.GetAuthenticationStateAsync();
            GlobalNotificationService.ClearMessages();

            // Redirect to the page the user was trying to access before if set
            var localStorageReturnUrl = await LocalStorage.GetItemAsync<string>(ReturnUrlKey);
            if (!string.IsNullOrEmpty(localStorageReturnUrl))
            {
                await LocalStorage.RemoveItemAsync(ReturnUrlKey);
                NavigationManager.NavigateTo(localStorageReturnUrl);
            }
            else
            {
                NavigationManager.NavigateTo("/");
            }
        }
        catch (Exception)
        {
            _isLoading = false;
            _errorMessage = Localizer["LoginError"];
            StateHasChanged();
        }
    }

    /// <summary>
    /// Handle error.
    /// </summary>
    private void HandleErrorAsync(string errorMessage)
    {
        _isLoading = false;
        _errorMessage = errorMessage;
        StateHasChanged();
    }

    /// <summary>
    /// Handle cancel button.
    /// </summary>
    private void HandleCancel()
    {
        _mobileUnlockUtility?.Cleanup();
        _countdownTimer?.Dispose();
        NavigationManager.NavigateTo("/user/login");
    }

    /// <summary>
    /// Format time remaining as MM:SS.
    /// </summary>
    private string FormatTime(int seconds)
    {
        var mins = seconds / 60;
        var secs = seconds % 60;
        return $"{mins}:{secs:D2}";
    }

    /// <summary>
    /// Start countdown timer.
    /// </summary>
    private void StartCountdownTimer()
    {
        _countdownTimer = new System.Threading.Timer(_ =>
        {
            if (_timeRemaining > 0)
            {
                _timeRemaining--;
                InvokeAsync(StateHasChanged);
            }
            else
            {
                _countdownTimer?.Dispose();
                _mobileUnlockUtility?.StopPolling();
            }
        }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
    }

    /// <inheritdoc/>
    public void Dispose()
    {
        _mobileUnlockUtility?.Dispose();
        _countdownTimer?.Dispose();
    }
}
